<!DOCTYPE html>
<html lang="en">
	<head>
		<title>pepperflip.me</title>
		<meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/> <!--320-->
        <meta property="og:title" content="pepperflip.me"/>
        <meta property="og:url" content="http://pepperflip.me"/>
        <meta property="og:description" content="I just attempted a pepperflip! Care to try your luck?"/>
        <meta property="og:image" content="http://pepperflip.me/pepper.png" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">
		<link rel="stylesheet" type="text/css" href="css/pepper.css">
        <script src="js/jquery.min.js"></script>
        <script src="js/hammer.min.js"></script>
	</head>
	<body>
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=136227163215009";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>
        <div class='fb-share-button hideImportant' data-href='http://pepperflip.me' data-width='300' data-type='button'></div>
        <div id=userScore>0</div>
        <button class='hideImportant' type='button' onclick='removePopover();'>Try Again?</button>
        <header>
            Drag Shaker Down to Pepperflip...
        </header>
        <div id="score"></div>
		<script src="build/three.min.js"></script>
        <script src="examples/js/Detector.js"></script>
		<script>
			var camera, scene, renderer;
			var pepper, empty, pepperTop, shaker, background, table;
            var pepperCylinder, emptyCylinder, topCylinder, tableCube, backgroundPlane;
            var endAnimation = false;
            var ready = true;
            var readyToo = false;
            var score = 0;
			init();
			animate();
            var speed;
            var weight;
            var newJump, jumpNotEnded = false;
            gravity = 0;
            
			function init() {
                renderer = Detector.webgl? new THREE.WebGLRenderer(): alert('Sorry, your browser does not support WebGL. We recommend Google Chrome for the best possible experience.');
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );
				camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.z = 400;
				scene = new THREE.Scene();
                                
				newShaker();
                
                tableCube = new THREE.CubeGeometry( 1800, 100, 500 );
				var tableTexture = THREE.ImageUtils.loadTexture( 'textures/wood.jpg' );
				tableTexture.anisotropy = renderer.getMaxAnisotropy();
				var tableMaterial = new THREE.MeshBasicMaterial( { map: tableTexture } );
				table = new THREE.Mesh( tableCube, tableMaterial );
                table.position.y = -235;
                
                backgroundPlane = new THREE.PlaneGeometry(window.innerWidth*2, window.innerHeight*100);
                var backgroundTexture = new THREE.ImageUtils.loadTexture('textures/clouds.jpg');
                backgroundTexture.wrapS = backgroundTexture.wrapT = THREE.RepeatWrapping;
                backgroundTexture.repeat.set(6,300);
                backgroundTexture.anistropy = renderer.getMaxAnisotropy();
                var backgroundMaterial = new THREE.MeshBasicMaterial( {map: backgroundTexture } );
                background = new THREE.Mesh( backgroundPlane, backgroundMaterial );
                background.position.z = -200;
                
                scene.add(table);
                scene.add(background);
				window.addEventListener( 'resize', onWindowResize, false );
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight ); 
			}
            
            function newShaker() {
                shaker = new THREE.Object3D();
                
                //create pepper shaker material
                var pepperTexture = THREE.ImageUtils.loadTexture( 'textures/pepper.jpg' );
                pepperTexture.wrapS = pepperTexture.wrapT = THREE.RepeatWrapping;
                pepperTexture.repeat.set(2,2);
				pepperTexture.anisotropy = renderer.getMaxAnisotropy();
				var pepperMaterial = new THREE.MeshBasicMaterial( { map: pepperTexture } );
                
                //create empty space material
				var emptyMaterial = new THREE.MeshBasicMaterial( { transparent: true, opacity: 0.5 } );
                
                switch(getRandomInt(1, 3)) {
                    case 1: //half-full
                        weight = 3;
                        pepperCylinder = new THREE.CylinderGeometry(100, 120, 120, 50, 50, false);
                        emptyCylinder = new THREE.CylinderGeometry(80, 100, 120, 50, 50, false);
                        pepper = new THREE.Mesh( pepperCylinder, pepperMaterial );
                        empty = new THREE.Mesh( emptyCylinder, emptyMaterial );
                        pepper.position.y = -60;
                        empty.position.y = 60;
                        break;
                    case 2: //full
                        weight = 5;
                        pepperCylinder = new THREE.CylinderGeometry(80, 120, 240, 50, 50, false);
                        emptyCylinder = new THREE.CylinderGeometry(0, 0, 0, 0, 0, false);
                        pepper = new THREE.Mesh( pepperCylinder, pepperMaterial );
                        empty = new THREE.Mesh( emptyCylinder, emptyMaterial );
                        break;
                    case 3: //empty
                        weight = 1;
                        pepperCylinder = new THREE.CylinderGeometry(0, 0, 0, 0, 0, false);
                        emptyCylinder = new THREE.CylinderGeometry(80, 120, 240, 50, 50, false);
                        pepper = new THREE.Mesh( pepperCylinder, pepperMaterial );
                        empty = new THREE.Mesh( emptyCylinder, emptyMaterial );
                        break;
                }
                
                //create pepper shaker top
                topCylinder = new THREE.CylinderGeometry(70, 80, 60, 50, 50, false);
				var topTexture = THREE.ImageUtils.loadTexture( 'textures/chrome.jpg' );
				topTexture.anisotropy = renderer.getMaxAnisotropy();
				var topMaterial = new THREE.MeshBasicMaterial( { map: topTexture } );
				pepperTop = new THREE.Mesh( topCylinder, topMaterial );
                pepperTop.position.y = 150;
                
                //combine parts
                shaker.add(pepper);
                shaker.add(empty);
                shaker.add(pepperTop);
                shaker.rotation.y = 1;
                
                //add to scene
				scene.add( shaker );
            }
            
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            
			function animate() {
				requestAnimationFrame( animate );
                var rising = !ready && speed > gravity;
                var falling = !ready && !rising && shaker.position.y > 0;
				if(rising) {
                    gravity *= 1.05+(weight/100);
                    shaker.rotation.x += 0.2;
                    shaker.position.y += (speed - gravity)*0.01;
                    camera.position.y += (speed - gravity)*0.01;
                    updateScore(score+=10);
                }
                else if(falling) {
                    if(shaker.position.y-50 > 0) {
                        shaker.rotation.x += 0.05;
                        gravity /= 1.05+(weight/100);
                        shaker.position.y -= (speed-1)*0.01; 
                        camera.position.y -= (speed-1)*0.01;
                    }
                    else {
                        shaker.position.y = 0;
                        camera.position.y = 0;
                        endAnimation = true;
                    }
                }
                else if(endAnimation) {
                    if(shaker.rotation.x%6.3 < 0.4) {
                        if(shaker.rotation.x%6.3 >= 0) shaker.rotation.x -= 0.1;
                        if(shaker.rotation.x%6.3 < 0.4) {
                            popover(true, 'You got it!', true);
                            updateScore(score+1000);
                        }
                    }
                    else if(shaker.rotation.x%6.3 > 5.9) {
                        if(shaker.rotation.x%6.3 <= 6.3) shaker.rotation.x += 0.1;
                        if(shaker.rotation.x%6.3 < 5.9) {
                            popover(true, 'You got it!', true);
                            updateScore(score+1000);
                        }
                    }
                    else if(shaker.rotation.x%6.3 < 3.5 && shaker.rotation.x%6.3 > 3.1) {
                        if(shaker.rotation.x%6.3 >= 3.1) shaker.rotation.x -= 0.1;
                        if(shaker.rotation.x%6.3 < 3.1) {
                            popover(false, 'It landed on its head!', true);
                            updateScore(score-1000);
                        }
                    }
                    else if(shaker.rotation.x%6.3 > 2.7 && shaker.rotation.x%6.3 < 3.1) {
                        if(shaker.rotation.x%6.3 <= 3.1) shaker.rotation.x += 0.1;
                        if(shaker.rotation.x%6.3 > 3.1) {
                            popover(false, 'It landed on its head!', true);
                            updateScore(score-1000);
                        }
                    }
                    
                    else if(shaker.rotation.x%6.3 > 0.4 && shaker.rotation.x%6.3 < 1.6) {
                        if(shaker.rotation.x%6.3 <= 1.6) shaker.rotation.x += 0.1;
                        if(shaker.rotation.x%6.3 > 1.6) {
                            shaker.position.y = - 25;
                            popover(false, "Sorry, you couldn't make the flip.", true);
                        }
                    }
                    else if(shaker.rotation.x%6.3 > 1.6 && shaker.rotation.x%6.3 < 2.7) {
                        if(shaker.rotation.x%6.3 >= 1.6) shaker.rotation.x -= 0.1;
                        if(shaker.rotation.x%6.3 < 1.6) {
                            shaker.position.y = - 50;
                            popover(false, "Sorry, you couldn't make the flip.", true);
                        }
                    }
                    else if(shaker.rotation.x%6.3 > 3.5 && shaker.rotation.x%6.3 < 4.7) {
                        if(shaker.rotation.x%6.3 <= 4.7) shaker.rotation.x += 0.1;
                        if(shaker.rotation.x%6.3 > 4.7) {
                            popover(false, "Sorry, you couldn't make the flip.", true);
                        }
                    }
                    else if(shaker.rotation.x%6.3 > 4.7 && shaker.rotation.x%6.3 < 5.9) {
                        if(shaker.rotation.x%6.3 >= 4.7) shaker.rotation.x -= 0.1;
                        if(shaker.rotation.x%6.3 < 4.7) {
                            popover(false, "Sorry, you couldn't make the flip.", true);
                        }
                    }
                    else popover(false, "Sorry, you couldn't make the flip.", true);
                }

                renderer.render( scene, camera );
			}
            
            $('canvas').attr('id','canvas');
            Hammer(document.getElementById('canvas')).on('release', function(event) {
                if(readyToo) {
                    readyToo = false;
                    
                    if((event.gesture.deltaY/event.gesture.deltaTime) > 0.1) {
                        gravity = 1;
                        speed = 1000*(event.gesture.deltaY/event.gesture.deltaTime);
                        $('header').html('Flipping!');
                    }
                    else popover(false, 'Pull faster!', false);
                }
            })
            .on('dragstart', function(event) {
                event.gesture.preventDefault();
                if(ready) {
                    ready = false;
                    readyToo = true;
                }
            });
            
            function popover(success, message, share) {
                endAnimation = false;
                if(success) $('#score').css('background', '#2ecc71').html(message).slideDown();
                else if(!success) $('#score').css('background', '#c0392b').html(message).slideDown();
                if(share) $('.fb_iframe_widget').removeClass('hideImportant');
                $('button').removeClass('hideImportant');
            }
            
            function removePopover(){
                $('header').html('Drag Shaker Down to Pepperflip...');
                $('button').addClass('hideImportant');
                $('.fb_iframe_widget').addClass('hideImportant');
                $('#score').slideUp(function(){
                    speed = 0;
                    updateScore(0);
                    shaker.rotation.x = 0;
                    shaker.position.y = 0;
                    scene.remove(shaker);
                    newShaker();
                    gravity = 1;
                    ready = true;
                    readyToo = false;
                });
            }
            
            function updateScore(newScore) {
                if(newScore >= score)
                    score = newScore;
                else score = 0;
                $('#userScore').html(score);
            }
		</script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-49240127-1', 'pepperflip.me');
          ga('send', 'pageview');
        </script>
	</body>
</html>